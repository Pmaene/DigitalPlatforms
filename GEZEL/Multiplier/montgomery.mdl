dp adder_dp (in sel : ns(1); in a, b : ns(1026); out s: ns(1027)) {
    sig b_eff : ns(1026);

    always {
        b_eff = sel == 1 ? (~b + 1) : b;
	    s = a + b_eff;
    }
}

dp montgomery_dp (in a, b, m : ns(1024); out r : ns(1027))
{
    reg counter : ns(10);
    reg r_reg   : ns(1027);
    reg a_reg   : ns(1024);

    sig r_tmp   : ns(1027);
    sig sel     : ns(1);
    sig x       : ns(1027);
    sig y       : ns(1024);

    use adder_dp(sel, x, y, r_tmp);

    sfg init {
	    counter = 0;
	    r = 0;
	    r_reg = 0;
        
        x = 0;
        y = 0;
        sel = 0;
    }

    sfg loop {
    }

    sfg save_r {
        sel = 0;
        x = 0;
        y = 0;
	    r = r_reg;
        $display("R: ", $dec, r);
    }

    sfg count_inc {
	    counter = counter + 1;
        a_reg = a_reg >> 1;

        $display("Rtmp: ", $dec, r_tmp);
    }

    sfg count_rst {
	    counter = 0;
    }

    sfg sum {
        x = r;
        y = a[0] == 0 ? 0 : b;
        sel = 0;
        r_reg = r_tmp;
    }

    sfg equal_to_zero {
	    r_reg = r_tmp >> 1;
        r = r_reg;
    }

    sfg not_equal_to_zero {
        sel = 0;
        x = r_tmp;
        y = m;
	    r_reg = r_tmp >> 1;
        r = r_reg;
    }

    sfg overflow_check {
        sel = 1;
        x = r_tmp;
        y = r >= m ? m : 0;
        r_reg = r_tmp;
    }

    sfg stop {
        sel = 0;
        x = 0;
        y = 0;
        r = r_reg;
	    $finish;
    }
}

fsm montgomery (montgomery_dp)
{
    initial init;
    state loop, stop, save_r;

    @init	    (init) -> loop;
    @loop	    if (counter >= 7) then
			        (count_rst, overflow_check) -> stop;
		        else if (r[0] == 0) then
			        (count_inc, sum, equal_to_zero) -> save_r;
		        else 
			        (count_inc, sum, not_equal_to_zero) -> save_r;
    @save_r     (save_r) -> loop;
    @stop       (stop) -> stop;
}

dp display_dp (in a, b, m : ns(1026); in r: ns(1027)) {
    always {
	    $display("A: ", $dec, a, " B: ", $dec, b, " M: ", $dec, m, " R: ", $dec, r);
    }
}

dp montgomery_test (out a, b, m : ns(1026))
{
	sfg do_always
	{
		a = 112;
		b = 50;
        m = 97;
    }
}

hardwired montgomery_hw (montgomery_test) { do_always; }

dp montgomery_sys
{
	sig a : ns(1026);
	sig b : ns(1026);
	sig m : ns(1026);
    reg r : ns(1027);
	
	use montgomery_test(a, b, m);
	use montgomery_dp(a, b, m, r);
	use display_dp(a, b, m, r);
}

system S
{
	montgomery_sys;
}

